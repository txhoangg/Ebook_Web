<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quản trị - EBook Haven</title>
    <link rel="stylesheet" href="../../assets/css/normalize.css" />
    <link rel="stylesheet" href="../../assets/css/main.css" />
    <link rel="stylesheet" href="../../assets/css/responsive.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      .admin-container {
        display: flex;
        min-height: calc(100vh - 70px - 400px); /* Trừ header và footer */
      }

      .admin-sidebar {
        width: 250px;
        background-color: var(--dark);
        color: white;
        padding: 20px 0;
      }

      .admin-sidebar-header {
        padding: 0 20px 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        margin-bottom: 20px;
      }

      .admin-sidebar-header h2 {
        margin: 0;
        font-size: 1.5rem;
      }

      .admin-menu {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .admin-menu-item {
        padding: 12px 20px;
        cursor: pointer;
        transition: all 0.3s;
      }

      .admin-menu-item:hover,
      .admin-menu-item.active {
        background-color: rgba(255, 255, 255, 0.1);
      }

      .admin-menu-item a {
        color: white;
        text-decoration: none;
        display: block;
      }

      .admin-content {
        flex: 1;
        padding: 30px;
      }

      .admin-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
      }

      .admin-header h1 {
        margin: 0;
      }

      .admin-cards {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .admin-card {
        background-color: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .admin-card-title {
        color: var(--gray);
        font-size: 0.9rem;
        text-transform: uppercase;
        margin-bottom: 10px;
      }

      .admin-card-value {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .admin-card-change {
        display: flex;
        align-items: center;
        font-size: 0.9rem;
      }

      .admin-card-change.positive {
        color: var(--secondary);
      }

      .admin-card-change.negative {
        color: var(--danger);
      }

      .admin-tables {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      .admin-table {
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .admin-table-header {
        padding: 15px 20px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .admin-table-header h3 {
        margin: 0;
      }

      .admin-table-content {
        padding: 0 20px;
      }

      .admin-table table {
        width: 100%;
        border-collapse: collapse;
      }

      .admin-table th,
      .admin-table td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid #eee;
      }

      .admin-table th {
        font-weight: 500;
        color: var(--gray);
      }

      .admin-table tbody tr:last-child td {
        border-bottom: none;
      }

      .admin-table tbody tr:hover {
        background-color: #f8f9fa;
      }

      .error-message {
        background-color: rgba(239, 71, 111, 0.1);
        color: var(--danger);
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: none;
      }

      .error-message.show {
        display: block;
      }

      #debug-info {
        position: fixed;
        bottom: 10px;
        right: 10px;
        background-color: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 10px;
        border-radius: 5px;
        max-width: 400px;
        max-height: 300px;
        overflow: auto;
        z-index: 9999;
        font-size: 12px;
        font-family: monospace;
        display: none;
      }

      .debug-toggle {
        position: fixed;
        bottom: 10px;
        right: 10px;
        background-color: var(--dark);
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 5px;
        cursor: pointer;
        z-index: 10000;
      }

      @media (max-width: 768px) {
        .admin-container {
          flex-direction: column;
        }

        .admin-sidebar {
          width: 100%;
          padding: 10px 0;
        }

        .admin-sidebar-header {
          padding: 10px 20px;
        }

        .admin-content {
          padding: 20px;
        }

        .admin-tables {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="container header-container">
        <a href="../../index.html" class="logo">Ebook<span>Haven</span></a>
        <div class="search-bar">
          <input
            type="text"
            id="search-input"
            placeholder="Tìm kiếm sách, tác giả..."
          />
          <button><i class="fas fa-search"></i></button>
        </div>
        <div class="mobile-menu-toggle" id="mobile-menu-toggle">
          <span></span>
          <span></span>
          <span></span>
        </div>
        <ul class="nav-menu" id="nav-menu">
          <li>
            <a href="../../index.html"><i class="fas fa-home"></i> Trang chủ</a>
          </li>
          <li>
            <a href="../categories.html"
              ><i class="fas fa-tags"></i> Danh mục</a
            >
          </li>
          <li>
            <a href="../upload-book.html"
              ><i class="fas fa-upload"></i> Tải lên sách</a
            >
          </li>
          <li>
            <a href="#" id="login-btn"
              ><i class="fas fa-sign-in-alt"></i> Đăng nhập</a
            >
          </li>
          <li>
            <a href="#" id="register-btn"
              ><i class="fas fa-user-plus"></i> Đăng ký</a
            >
          </li>
        </ul>
      </div>
    </header>

    <div class="error-message" id="error-container">
      <i class="fas fa-exclamation-circle"></i>
      <span id="error-message">Đã xảy ra lỗi</span>
    </div>

    <div class="admin-container">
      <div class="admin-sidebar">
        <div class="admin-sidebar-header">
          <h2>Admin Panel</h2>
        </div>
        <ul class="admin-menu">
          <li class="admin-menu-item active">
            <a href="dashboard.html">Tổng quan</a>
          </li>
          <li class="admin-menu-item"><a href="books.html">Quản lý sách</a></li>
          <li class="admin-menu-item">
            <a href="users.html">Quản lý người dùng</a>
          </li>
          <li class="admin-menu-item">
            <a href="categories.html">Quản lý danh mục</a>
          </li>
          <li class="admin-menu-item">
            <a href="../../index.html">Quay lại trang chủ</a>
          </li>
        </ul>
      </div>

      <div class="admin-content">
        <div class="admin-header">
          <h1>Tổng quan</h1>
          <div class="admin-date">
            <span id="current-date">Đang tải...</span>
          </div>
        </div>

        <div class="admin-cards">
          <div class="admin-card">
            <div class="admin-card-title">Tổng số sách</div>
            <div class="admin-card-value" id="total-books">-</div>
            <div class="admin-card-change positive" id="books-change">
              +5% so với tháng trước
            </div>
          </div>

          <div class="admin-card">
            <div class="admin-card-title">Tổng người dùng</div>
            <div class="admin-card-value" id="total-users">-</div>
            <div class="admin-card-change positive" id="users-change">
              +12% so với tháng trước
            </div>
          </div>

          <div class="admin-card">
            <div class="admin-card-title">Lượt tải xuống</div>
            <div class="admin-card-value" id="total-downloads">-</div>
            <div class="admin-card-change positive" id="downloads-change">
              +8% so với tháng trước
            </div>
          </div>

          <div class="admin-card">
            <div class="admin-card-title">Đánh giá trung bình</div>
            <div class="admin-card-value" id="avg-rating">-</div>
            <div class="admin-card-change positive" id="rating-change">
              +0.2 so với tháng trước
            </div>
          </div>
        </div>

        <div class="admin-tables">
          <div class="admin-table">
            <div class="admin-table-header">
              <h3>Sách mới nhất</h3>
              <a href="books.html" class="link">Xem tất cả</a>
            </div>
            <div class="admin-table-content">
              <table>
                <thead>
                  <tr>
                    <th>Tiêu đề</th>
                    <th>Tác giả</th>
                    <th>Ngày đăng</th>
                    <th>Trạng thái</th>
                  </tr>
                </thead>
                <tbody id="latest-books-table">
                  <tr>
                    <td colspan="4">Đang tải...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="admin-table">
            <div class="admin-table-header">
              <h3>Người dùng mới nhất</h3>
              <a href="users.html" class="link">Xem tất cả</a>
            </div>
            <div class="admin-table-content">
              <table>
                <thead>
                  <tr>
                    <th>Tên người dùng</th>
                    <th>Email</th>
                    <th>Ngày đăng ký</th>
                    <th>Vai trò</th>
                  </tr>
                </thead>
                <tbody id="latest-users-table">
                  <tr>
                    <td colspan="4">Đang tải...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <button class="debug-toggle" id="debug-toggle">Debug</button>
    <div id="debug-info"></div>

    <footer>
      <div class="container footer-container">
        <div class="footer-col">
          <h3>Ebook Haven</h3>
          <p>
            Thư viện sách điện tử cho mọi người yêu thích đọc sách và học hỏi.
          </p>

          <div class="social-icons">
            <a href="#"><i class="fab fa-facebook-f"></i></a>
            <a href="#"><i class="fab fa-twitter"></i></a>
            <a href="#"><i class="fab fa-instagram"></i></a>
          </div>
        </div>
        <div class="footer-col">
          <h3>Khám phá</h3>
          <ul>
            <li><a href="categories.html">Danh mục</a></li>
            <li><a href="upload-book.html">Tải lên sách</a></li>
            <li><a href="profile.html">Trang cá nhân</a></li>
          </ul>
        </div>
        <div class="footer-col">
          <h3>Liên kết</h3>
          <ul>
            <li><a href="#">Giới thiệu</a></li>
            <li><a href="#">Điều khoản sử dụng</a></li>
            <li><a href="#">Chính sách bảo mật</a></li>
            <li><a href="#">Liên hệ</a></li>
          </ul>
        </div>
        <div class="footer-col">
          <h3>Hỗ trợ</h3>
          <ul>
            <li><a href="#">Câu hỏi thường gặp</a></li>
            <li><a href="#">Hướng dẫn sử dụng</a></li>
            <li><a href="#">Báo cáo lỗi</a></li>
          </ul>
        </div>
      </div>
      <div class="container">
        <div class="copyright">
          &copy; 2025 Ebook Haven. Tất cả quyền được bảo lưu.
        </div>
      </div>
    </footer>

    <script src="../../assets/js/api.service.js"></script>
    <script src="../../assets/js/main.js"></script>
    <script>
      function initAnimations() {
        const animateItems = document.querySelectorAll(".animate-item");

        if (animateItems.length > 0) {
          animateItems.forEach((item, index) => {
            item.style.opacity = "0";
            item.style.transform = "translateY(20px)";
            item.style.transition = "opacity 0.3s ease, transform 0.3s ease";

            setTimeout(() => {
              item.style.opacity = "1";
              item.style.transform = "translateY(0)";
            }, 100 * index);
          });
        }
      }

      window.debugLog = function (message) {
        const debugDiv = document.getElementById("debug-info");
        if (debugDiv) {
          const time = new Date().toLocaleTimeString();
          debugDiv.innerHTML += `<div>[${time}] ${message}</div>`;
          debugDiv.scrollTop = debugDiv.scrollHeight;
        }
      };

      document
        .getElementById("debug-toggle")
        .addEventListener("click", function () {
          const debugInfo = document.getElementById("debug-info");
          if (debugInfo.style.display === "none" || !debugInfo.style.display) {
            debugInfo.style.display = "block";
          } else {
            debugInfo.style.display = "none";
          }
        });

      function showError(message) {
        const errorContainer = document.getElementById("error-container");
        const errorMessage = document.getElementById("error-message");

        errorMessage.textContent = message;
        errorContainer.classList.add("show");

        debugLog(`ERROR: ${message}`);
      }

      function checkToken() {
        const user = apiService.auth.getCurrentUser();
        if (!user || !user.accessToken) {
          return false;
        }

        return true;
      }

      document.addEventListener("DOMContentLoaded", async function () {
        debugLog("Trang đã được tải, bắt đầu khởi tạo...");

        if (!apiService.auth.isAuthenticated()) {
          debugLog("Người dùng chưa đăng nhập");
          showError("Bạn cần đăng nhập để truy cập trang quản trị!");
          setTimeout(() => {
            window.location.href = "../../index.html";
          }, 2000);
          return;
        }

        const user = apiService.auth.getCurrentUser();
        debugLog(`Người dùng: ${user.username}, Vai trò: ${user.role}`);

        if (user.role !== "admin") {
          debugLog("Người dùng không có quyền admin");
          showError("Bạn không có quyền truy cập trang quản trị!");
          setTimeout(() => {
            window.location.href = "../../index.html";
          }, 2000);
          return;
        }

        if (!checkToken()) {
          debugLog("Token không hợp lệ hoặc đã hết hạn");
          showError("Phiên đăng nhập đã hết hạn, vui lòng đăng nhập lại!");
          setTimeout(() => {
            apiService.auth.logout();
            window.location.href = "../../index.html";
          }, 2000);
          return;
        }

        const now = new Date();
        document.getElementById("current-date").textContent =
          now.toLocaleDateString("vi-VN", {
            weekday: "long",
            year: "numeric",
            month: "long",
            day: "numeric",
          });

        debugLog("Ngày hiện tại đã được cập nhật");

        try {
          debugLog("Bắt đầu tải dữ liệu thống kê...");

          const statsPromise = Promise.race([
            apiService.admin.getStats(),
            new Promise((_, reject) =>
              setTimeout(
                () => reject(new Error("Thời gian yêu cầu quá lâu")),
                10000
              )
            ),
          ]);

          const stats = await statsPromise;
          debugLog("Đã nhận được dữ liệu thống kê");

          document.getElementById("total-books").textContent =
            stats.totalBooks || 0;
          document.getElementById("total-users").textContent =
            stats.totalUsers || 0;
          document.getElementById("total-downloads").textContent =
            stats.totalDownloads || 0;
          document.getElementById("avg-rating").textContent = parseFloat(
            stats.avgRating || 0
          ).toFixed(1);

          document.getElementById("books-change").textContent = `${
            stats.booksGrowth > 0 ? "+" : ""
          }${stats.booksGrowth || 0}% so với tháng trước`;
          document.getElementById("users-change").textContent = `${
            stats.usersGrowth > 0 ? "+" : ""
          }${stats.usersGrowth || 0}% so với tháng trước`;
          document.getElementById("downloads-change").textContent = `${
            stats.downloadsGrowth > 0 ? "+" : ""
          }${stats.downloadsGrowth || 0}% so với tháng trước`;
          document.getElementById("rating-change").textContent = `${
            stats.ratingChange > 0 ? "+" : ""
          }${stats.ratingChange || 0} so với tháng trước`;

          if (stats.booksGrowth < 0) {
            document
              .getElementById("books-change")
              .classList.remove("positive");
            document.getElementById("books-change").classList.add("negative");
          }

          if (stats.usersGrowth < 0) {
            document
              .getElementById("users-change")
              .classList.remove("positive");
            document.getElementById("users-change").classList.add("negative");
          }

          if (stats.downloadsGrowth < 0) {
            document
              .getElementById("downloads-change")
              .classList.remove("positive");
            document
              .getElementById("downloads-change")
              .classList.add("negative");
          }

          if (stats.ratingChange < 0) {
            document
              .getElementById("rating-change")
              .classList.remove("positive");
            document.getElementById("rating-change").classList.add("negative");
          }

          debugLog("Bắt đầu tải danh sách sách mới nhất...");
          const latestBooks = await apiService.admin.getLatestBooks();
          debugLog(`Đã nhận được ${latestBooks.length} sách mới nhất`);
          renderLatestBooks(latestBooks);

          debugLog("Bắt đầu tải danh sách người dùng mới nhất...");
          const latestUsers = await apiService.admin.getLatestUsers();
          debugLog(`Đã nhận được ${latestUsers.length} người dùng mới nhất`);
          renderLatestUsers(latestUsers);

          debugLog("Tất cả dữ liệu đã được tải thành công!");

          if (typeof initAnimations === "function") {
            initAnimations();
          }
        } catch (error) {
          console.error("Error loading admin dashboard:", error);
          debugLog(`Lỗi: ${error.message}`);

          if (error.message.includes("Authentication")) {
            showError("Xác thực thất bại. Vui lòng đăng nhập lại!");
            setTimeout(() => {
              apiService.auth.logout();
              window.location.href = "../../index.html";
            }, 2000);
          } else if (
            error.message.includes("timeout") ||
            error.message.includes("quá lâu")
          ) {
            showError(
              "Không thể kết nối đến máy chủ. Vui lòng kiểm tra kết nối mạng và thử lại sau!"
            );
          } else {
            showError("Lỗi khi tải dữ liệu! " + error.message);
          }

          renderEmptyData();
        }
      });

      function renderEmptyData() {
        document.getElementById("total-books").textContent = "0";
        document.getElementById("total-users").textContent = "0";
        document.getElementById("total-downloads").textContent = "0";
        document.getElementById("avg-rating").textContent = "0.0";

        document.getElementById("books-change").textContent =
          "0% so với tháng trước";
        document.getElementById("users-change").textContent =
          "0% so với tháng trước";
        document.getElementById("downloads-change").textContent =
          "0% so với tháng trước";
        document.getElementById("rating-change").textContent =
          "0 so với tháng trước";

        document.getElementById("latest-books-table").innerHTML =
          '<tr><td colspan="4">Không có dữ liệu</td></tr>';
        document.getElementById("latest-users-table").innerHTML =
          '<tr><td colspan="4">Không có dữ liệu</td></tr>';
      }

      function renderLatestBooks(books) {
        debugLog("Đang render danh sách sách mới nhất");
        const tableBody = document.getElementById("latest-books-table");

        if (!books || books.length === 0) {
          tableBody.innerHTML =
            '<tr><td colspan="4">Không có dữ liệu</td></tr>';
          return;
        }

        tableBody.innerHTML = "";

        books.forEach((book) => {
          const row = document.createElement("tr");

          const dateCreated = new Date(book.createdAt).toLocaleDateString();

          row.innerHTML = `
                    <td>${book.title}</td>
                    <td>${book.author}</td>
                    <td>${dateCreated}</td>
                    <td><span class="status ${
                      book.status ? book.status.toLowerCase() : "pending"
                    }">${book.status || "Pending"}</span></td>
                `;

          tableBody.appendChild(row);
        });
      }

      function renderLatestUsers(users) {
        debugLog("Đang render danh sách người dùng mới nhất");
        const tableBody = document.getElementById("latest-users-table");

        if (!users || users.length === 0) {
          tableBody.innerHTML =
            '<tr><td colspan="4">Không có dữ liệu</td></tr>';
          return;
        }

        tableBody.innerHTML = "";

        users.forEach((user) => {
          const row = document.createElement("tr");

          const dateCreated = new Date(user.createdAt).toLocaleDateString();

          row.innerHTML = `
                    <td>${user.username}</td>
                    <td>${user.email}</td>
                    <td>${dateCreated}</td>
                    <td>${user.role || "user"}</td>
                `;

          tableBody.appendChild(row);
        });
      }
    </script>
    <div id="notification-container"></div>
  </body>
</html>
