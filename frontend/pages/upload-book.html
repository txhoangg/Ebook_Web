<!DOCTYPE html>
<html lang="vi">
  <head>
    <base href="/" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>T·∫£i l√™n s√°ch m·ªõi - EBook Haven</title>
    <link rel="stylesheet" href="../assets/css/normalize.css" />
    <link rel="stylesheet" href="../assets/css/main.css" />
    <link rel="stylesheet" href="../assets/css/responsive.css" />
    <!-- Th√™m v√†o <head> c·ªßa t·∫•t c·∫£ trang -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      /* Th√™m CSS cho trang upload */
      .upload-container {
        padding: 30px 0;
      }

      .upload-form {
        background-color: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .form-row {
        display: flex;
        flex-wrap: wrap;
        margin: 0 -15px;
      }

      .form-col {
        flex: 1;
        min-width: 300px;
        padding: 0 15px;
        margin-bottom: 20px;
      }

      .file-upload {
        border: 2px dashed var(--gray);
        padding: 30px;
        text-align: center;
        border-radius: 8px;
        margin-bottom: 20px;
        position: relative;
      }

      .file-upload.dragover {
        border-color: var(--primary);
        background-color: rgba(52, 152, 219, 0.05);
      }

      .file-upload input[type="file"] {
        position: absolute;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        opacity: 0;
        cursor: pointer;
      }

      .file-upload-icon {
        font-size: 2rem;
        margin-bottom: 10px;
        color: var(--primary);
      }

      .file-info {
        margin-top: 15px;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 4px;
        display: none;
      }

      .cover-preview {
        width: 150px;
        height: 200px;
        background-color: #f0f0f0;
        margin: 15px auto;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--gray);
        border-radius: 4px;
        overflow: hidden;
      }

      .cover-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .upload-actions {
        text-align: center;
        margin-top: 30px;
      }

      .upload-actions .btn {
        padding: 12px 30px;
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <header>
      <div class="container header-container">
        <a href="../index.html" class="logo">Ebook<span>Haven</span></a>
        <div class="search-bar">
          <input type="text" placeholder="T√¨m ki·∫øm s√°ch, t√°c gi·∫£..." />
          <button><i class="fas fa-search"></i></button>
        </div>
        <div class="mobile-menu-toggle">
          <span></span>
          <span></span>
          <span></span>
        </div>
        <ul class="nav-menu">
          <li><a href="../index.html">Trang ch·ªß</a></li>
          <li><a href="categories.html">Danh m·ª•c</a></li>
          <li><a href="upload-book.html">T·∫£i l√™n s√°ch</a></li>
          <li><a href="#" id="login-btn">ƒêƒÉng nh·∫≠p</a></li>
          <li>
            <a href="#" id="register-btn">ƒêƒÉng k√Ω</a>
          </li>
        </ul>
      </div>
    </header>

    <!-- Upload Page -->
    <div class="container upload-container">
      <h1>T·∫£i l√™n s√°ch m·ªõi</h1>
      <p>
        Chia s·∫ª ki·∫øn th·ª©c v√† ƒë√≥ng g√≥p v√†o th∆∞ vi·ªán c·ªßa ch√∫ng ta. L∆∞u √Ω r·∫±ng b·∫°n
        ch·ªâ n√™n t·∫£i l√™n nh·ªØng s√°ch m√† b·∫°n c√≥ quy·ªÅn s·ªü h·ªØu ho·∫∑c c√≥ gi·∫•y ph√©p ph√¢n
        ph·ªëi.
      </p>

      <div class="upload-form">
        <form id="book-upload-form">
          <div class="form-row">
            <div class="form-col">
              <div class="form-group">
                <label for="title"
                  >Ti√™u ƒë·ªÅ s√°ch <span class="required">*</span></label
                >
                <input type="text" id="title" name="title" required />
              </div>

              <div class="form-group">
                <label for="author"
                  >T√°c gi·∫£ <span class="required">*</span></label
                >
                <input type="text" id="author" name="author" required />
              </div>

              <div class="form-group">
                <label for="category"
                  >Danh m·ª•c <span class="required">*</span></label
                >
                <select id="category" name="categoryId" required>
                  <option value="">-- Ch·ªçn danh m·ª•c --</option>
                  <!-- Danh m·ª•c s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
                </select>
              </div>

              <div class="form-group">
                <label for="language">Ng√¥n ng·ªØ</label>
                <select id="language" name="language">
                  <option value="Vietnamese">Ti·∫øng Vi·ªát</option>
                  <option value="English">Ti·∫øng Anh</option>
                  <option value="French">Ti·∫øng Ph√°p</option>
                  <option value="German">Ti·∫øng ƒê·ª©c</option>
                  <option value="Spanish">Ti·∫øng T√¢y Ban Nha</option>
                  <option value="Chinese">Ti·∫øng Trung</option>
                  <option value="Japanese">Ti·∫øng Nh·∫≠t</option>
                  <option value="Korean">Ti·∫øng H√†n</option>
                  <option value="Other">Kh√°c</option>
                </select>
              </div>

              <div class="form-row">
                <div class="form-col">
                  <div class="form-group">
                    <label for="publishYear">NƒÉm xu·∫•t b·∫£n</label>
                    <input
                      type="number"
                      id="publishYear"
                      name="publishYear"
                      min="1800"
                      max="2025"
                    />
                  </div>
                </div>
                <div class="form-col">
                  <div class="form-group">
                    <label for="pageCount">S·ªë trang</label>
                    <input
                      type="number"
                      id="pageCount"
                      name="pageCount"
                      min="1"
                    />
                  </div>
                </div>
              </div>

              <div class="form-group">
                <label for="isbn">ISBN</label>
                <input type="text" id="isbn" name="isbn" />
              </div>
            </div>

            <div class="form-col">
              <div class="form-group">
                <label for="description">M√¥ t·∫£ s√°ch</label>
                <textarea
                  id="description"
                  name="description"
                  rows="5"
                ></textarea>
              </div>

              <div class="form-group">
                <label>File s√°ch <span class="required">*</span></label>
                <div class="file-upload" id="book-file-upload">
                  <div class="file-upload-icon">üìÑ</div>
                  <h3>K√©o th·∫£ file ho·∫∑c click ƒë·ªÉ ch·ªçn</h3>
                  <p>H·ªó tr·ª£ PDF, EPUB, MOBI (t·ªëi ƒëa 100MB)</p>
                  <input
                    type="file"
                    id="book-file"
                    name="file"
                    accept=".pdf,.epub,.mobi"
                    required
                  />
                  <div class="file-info" id="book-file-info"></div>
                </div>
              </div>

              <div class="form-group">
                <label>·∫¢nh b√¨a s√°ch</label>
                <div class="file-upload" id="cover-file-upload">
                  <div class="cover-preview" id="cover-preview">Xem tr∆∞·ªõc</div>
                  <div class="file-upload-icon">üñºÔ∏è</div>
                  <h3>K√©o th·∫£ ·∫£nh ho·∫∑c click ƒë·ªÉ ch·ªçn</h3>
                  <p>H·ªó tr·ª£ JPG, PNG (t·ªëi ƒëa 5MB)</p>
                  <input
                    type="file"
                    id="cover-file"
                    name="cover"
                    accept="image/jpeg,image/png"
                  />
                  <div class="file-info" id="cover-file-info"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="upload-actions">
            <button type="submit" class="btn btn-primary" id="upload-button">
              T·∫£i l√™n
            </button>
            <button type="button" class="btn btn-secondary" id="cancel-button">
              H·ªßy
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Footer -->
    <footer>
      <div class="container footer-container">
        <div class="footer-col">
          <h3>Ebook Haven</h3>
          <p>
            Th∆∞ vi·ªán s√°ch ƒëi·ªán t·ª≠ cho m·ªçi ng∆∞·ªùi y√™u th√≠ch ƒë·ªçc s√°ch v√† h·ªçc h·ªèi.
          </p>
          <!-- Thay th·∫ø trong t·∫•t c·∫£ trang -->
          <div class="social-icons">
            <a href="#"><i class="fab fa-facebook-f"></i></a>
            <a href="#"><i class="fab fa-twitter"></i></a>
            <a href="#"><i class="fab fa-instagram"></i></a>
          </div>
        </div>
        <div class="footer-col">
          <h3>Kh√°m ph√°</h3>
          <ul>
            <li><a href="categories.html">Danh m·ª•c</a></li>
            <li><a href="upload-book.html">T·∫£i l√™n s√°ch</a></li>
            <li><a href="profile.html">Trang c√° nh√¢n</a></li>
          </ul>
        </div>
        <div class="footer-col">
          <h3>Li√™n k·∫øt</h3>
          <ul>
            <li><a href="#">Gi·ªõi thi·ªáu</a></li>
            <li><a href="#">ƒêi·ªÅu kho·∫£n s·ª≠ d·ª•ng</a></li>
            <li><a href="#">Ch√≠nh s√°ch b·∫£o m·∫≠t</a></li>
            <li><a href="#">Li√™n h·ªá</a></li>
          </ul>
        </div>
        <div class="footer-col">
          <h3>H·ªó tr·ª£</h3>
          <ul>
            <li><a href="#">C√¢u h·ªèi th∆∞·ªùng g·∫∑p</a></li>
            <li><a href="#">H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng</a></li>
            <li><a href="#">B√°o c√°o l·ªói</a></li>
          </ul>
        </div>
      </div>
      <div class="container">
        <div class="copyright">
          &copy; 2025 Ebook Haven. T·∫•t c·∫£ quy·ªÅn ƒë∆∞·ª£c b·∫£o l∆∞u.
        </div>
      </div>
    </footer>

    <!-- Scripts -->
    <script src="../assets/js/api.service.js"></script>
    <script src="../assets/js/main.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", async function () {
        // Ki·ªÉm tra ƒëƒÉng nh·∫≠p
        if (!apiService.auth.isAuthenticated()) {
          // N·∫øu ch∆∞a ƒëƒÉng nh·∫≠p, chuy·ªÉn v·ªÅ trang ƒëƒÉng nh·∫≠p
          showAuthModal("login");

          // Disable form
          document.getElementById("book-upload-form").classList.add("disabled");
          document.getElementById("upload-button").disabled = true;

          alert("B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ t·∫£i l√™n s√°ch!");
          return;
        }

        // T·∫£i danh s√°ch danh m·ª•c
        try {
          const categories = await apiService.categories.getAll();
          const categorySelect = document.getElementById("category");

          categories.forEach((category) => {
            const option = document.createElement("option");
            option.value = category.id;
            option.textContent = category.name;
            categorySelect.appendChild(option);
          });
        } catch (error) {
          console.error("Error loading categories:", error);
        }

        // X·ª≠ l√Ω k√©o th·∫£ file s√°ch
        const bookFileUpload = document.getElementById("book-file-upload");
        const bookFileInput = document.getElementById("book-file");
        const bookFileInfo = document.getElementById("book-file-info");

        // K√©o th·∫£
        bookFileUpload.addEventListener("dragover", function (e) {
          e.preventDefault();
          this.classList.add("dragover");
        });

        bookFileUpload.addEventListener("dragleave", function () {
          this.classList.remove("dragover");
        });

        bookFileUpload.addEventListener("drop", function (e) {
          e.preventDefault();
          this.classList.remove("dragover");

          if (e.dataTransfer.files.length) {
            bookFileInput.files = e.dataTransfer.files;
            updateFileInfo(bookFileInput, bookFileInfo);
          }
        });

        // X·ª≠ l√Ω thay ƒë·ªïi file s√°ch
        bookFileInput.addEventListener("change", function () {
          updateFileInfo(this, bookFileInfo);
        });

        // X·ª≠ l√Ω k√©o th·∫£ ·∫£nh b√¨a
        const coverFileUpload = document.getElementById("cover-file-upload");
        const coverFileInput = document.getElementById("cover-file");
        const coverFileInfo = document.getElementById("cover-file-info");
        const coverPreview = document.getElementById("cover-preview");

        // K√©o th·∫£
        coverFileUpload.addEventListener("dragover", function (e) {
          e.preventDefault();
          this.classList.add("dragover");
        });

        coverFileUpload.addEventListener("dragleave", function () {
          this.classList.remove("dragover");
        });

        coverFileUpload.addEventListener("drop", function (e) {
          e.preventDefault();
          this.classList.remove("dragover");

          if (e.dataTransfer.files.length) {
            coverFileInput.files = e.dataTransfer.files;
            updateFileInfo(coverFileInput, coverFileInfo);
            previewCover(coverFileInput.files[0]);
          }
        });

        // X·ª≠ l√Ω thay ƒë·ªïi file ·∫£nh b√¨a
        coverFileInput.addEventListener("change", function () {
          updateFileInfo(this, coverFileInfo);
          if (this.files && this.files[0]) {
            previewCover(this.files[0]);
          }
        });

        // Xem tr∆∞·ªõc ·∫£nh b√¨a
        function previewCover(file) {
          if (!file.type.match("image.*")) {
            return;
          }

          const reader = new FileReader();

          reader.onload = function (e) {
            coverPreview.innerHTML = `<img src="${e.target.result}" alt="Cover Preview">`;
          };

          reader.readAsDataURL(file);
        }

        // C·∫≠p nh·∫≠t th√¥ng tin file
        function updateFileInfo(input, infoElement) {
          if (input.files && input.files[0]) {
            const file = input.files[0];
            const fileSize = formatFileSize(file.size);

            infoElement.innerHTML = `
                        <strong>T√™n file:</strong> ${file.name}<br>
                        <strong>K√≠ch th∆∞·ªõc:</strong> ${fileSize}<br>
                        <strong>Lo·∫°i:</strong> ${file.type}
                    `;
            infoElement.style.display = "block";
          }
        }

        // Format k√≠ch th∆∞·ªõc file
        function formatFileSize(bytes) {
          if (bytes >= 1024 * 1024) {
            return (bytes / (1024 * 1024)).toFixed(2) + " MB";
          } else if (bytes >= 1024) {
            return (bytes / 1024).toFixed(2) + " KB";
          } else {
            return bytes + " bytes";
          }
        }

        // X·ª≠ l√Ω n√∫t h·ªßy
        document
          .getElementById("cancel-button")
          .addEventListener("click", function () {
            if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën h·ªßy vi·ªác t·∫£i l√™n s√°ch?")) {
              window.location.href = "../index.html";
            }
          });

        // X·ª≠ l√Ω submit form
        document
          .getElementById("book-upload-form")
          .addEventListener("submit", async function (e) {
            e.preventDefault();

            // Ki·ªÉm tra ƒëƒÉng nh·∫≠p
            if (!apiService.auth.isAuthenticated()) {
              showAuthModal("login");
              return;
            }

            // L·∫•y d·ªØ li·ªáu form
            const formData = new FormData();

            // Th√™m c√°c tr∆∞·ªùng d·ªØ li·ªáu
            formData.append("title", document.getElementById("title").value);
            formData.append("author", document.getElementById("author").value);
            formData.append(
              "categoryId",
              document.getElementById("category").value
            );
            formData.append(
              "description",
              document.getElementById("description").value
            );
            formData.append(
              "language",
              document.getElementById("language").value
            );

            const publishYear = document.getElementById("publishYear").value;
            if (publishYear) {
              formData.append("publishYear", publishYear);
            }

            const pageCount = document.getElementById("pageCount").value;
            if (pageCount) {
              formData.append("pageCount", pageCount);
            }

            const isbn = document.getElementById("isbn").value;
            if (isbn) {
              formData.append("isbn", isbn);
            }

            // Th√™m file s√°ch
            const bookFile = document.getElementById("book-file").files[0];
            if (!bookFile) {
              alert("Vui l√≤ng ch·ªçn file s√°ch!");
              return;
            }
            formData.append("file", bookFile);

            // Th√™m ·∫£nh b√¨a (n·∫øu c√≥)
            const coverFile = document.getElementById("cover-file").files[0];
            if (coverFile) {
              formData.append("cover", coverFile);
            }

            // Disable n√∫t submit
            const uploadButton = document.getElementById("upload-button");
            uploadButton.disabled = true;
            uploadButton.textContent = "ƒêang t·∫£i l√™n...";

            try {
              // G·ªçi API t·∫£i s√°ch
              const response = await apiService.books.create({
                title: document.getElementById("title").value,
                author: document.getElementById("author").value,
                categoryId: document.getElementById("category").value,
                description: document.getElementById("description").value,
                language: document.getElementById("language").value,
                publishYear: publishYear || null,
                pageCount: pageCount || null,
                isbn: isbn || null,
                file: bookFile,
                cover: coverFile || null,
              });

              // N·∫øu th√†nh c√¥ng
              if (response.id) {
                alert("T·∫£i s√°ch l√™n th√†nh c√¥ng!");
                // Chuy·ªÉn ƒë·∫øn trang chi ti·∫øt s√°ch v·ª´a t·∫£i l√™n
                window.location.href = `book-detail.html?id=${response.id}`;
              } else {
                // L·ªói
                alert(response.message || "L·ªói khi t·∫£i s√°ch l√™n!");
                uploadButton.disabled = false;
                uploadButton.textContent = "T·∫£i l√™n";
              }
            } catch (error) {
              console.error("Error uploading book:", error);
              alert(
                "L·ªói khi t·∫£i s√°ch l√™n: " +
                  (error.message || "Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c v·ªõi server")
              );
              uploadButton.disabled = false;
              uploadButton.textContent = "T·∫£i l√™n";
            }
          });
      });
    </script>
    <div id="notification-container"></div>
  </body>
</html>
