<!DOCTYPE html>
<html lang="vi">
  <head>
    <base href="/" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tải lên sách mới - EBook Haven</title>
    <link rel="stylesheet" href="/assets/css/normalize.css" />
    <link rel="stylesheet" href="/assets/css/main.css" />
    <link rel="stylesheet" href="/assets/css/responsive.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="icon" href="/favicon.ico" type="image/x-icon" />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --primary: #4361ee;
        --primary-dark: #3a56d4;
        --secondary: #2ec4b6;
        --secondary-dark: #21a99d;
        --dark: #2b2d42;
        --dark-light: #3d405b;
        --light: #f8f9fa;
        --light-gray: #e9ecef;
        --gray: #6c757d;
        --danger: #ef476f;
        --warning: #ffd166;
        --success: #06d6a0;
        --accent: #ff9f1c;

        --font-main: "Poppins", sans-serif;

        --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.05);
        --shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        --shadow-lg: 0 15px 30px rgba(0, 0, 0, 0.1);
        --shadow-hover: 0 10px 25px rgba(67, 97, 238, 0.1);

        --radius-sm: 8px;
        --radius: 12px;
        --radius-lg: 20px;

        --transition: all 0.3s ease;
      }

      body {
        font-family: var(--font-main);
        background-color: #f8fafc;
        color: var(--dark);
        line-height: 1.6;
      }

      .upload-container {
        padding: 50px 0;
      }

      .upload-header {
        text-align: center;
        margin-bottom: 40px;
        position: relative;
      }

      .upload-header h1 {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--dark);
        margin-bottom: 15px;
      }

      .upload-header p {
        max-width: 700px;
        margin: 0 auto;
        color: var(--gray);
        font-size: 1.1rem;
      }

      .upload-header:after {
        content: "";
        display: block;
        width: 80px;
        height: 4px;
        background: linear-gradient(to right, var(--primary), var(--secondary));
        margin: 25px auto 0;
        border-radius: 2px;
      }

      .upload-form {
        background-color: white;
        padding: 40px;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        margin-bottom: 50px;
        border: 1px solid rgba(0, 0, 0, 0.03);
      }

      .form-row {
        display: flex;
        flex-wrap: wrap;
        margin: 0 -15px 20px;
      }

      .form-col {
        flex: 1;
        min-width: 300px;
        padding: 0 15px;
      }

      .form-group {
        margin-bottom: 25px;
      }

      .form-group label {
        display: block;
        margin-bottom: 10px;
        font-weight: 500;
        color: var(--dark);
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .form-group label .required {
        color: var(--danger);
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid var(--light-gray);
        border-radius: var(--radius-sm);
        font-size: 1rem;
        transition: all 0.3s ease;
        background-color: var(--light);
      }

      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        outline: none;
        background-color: white;
      }

      .form-group textarea {
        min-height: 150px;
        resize: vertical;
      }

      .file-upload {
        border: 2px dashed var(--light-gray);
        padding: 30px;
        text-align: center;
        border-radius: var(--radius);
        margin-bottom: 20px;
        position: relative;
        transition: all 0.3s ease;
        background-color: var(--light);
      }

      .file-upload.dragover {
        border-color: var(--primary);
        background-color: rgba(67, 97, 238, 0.05);
      }

      .file-upload input[type="file"] {
        position: absolute;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        opacity: 0;
        cursor: pointer;
      }

      .file-upload-icon {
        font-size: 2.5rem;
        margin-bottom: 15px;
        color: var(--primary);
        display: inline-block;
        width: 80px;
        height: 80px;
        line-height: 80px;
        background-color: rgba(67, 97, 238, 0.1);
        border-radius: 50%;
      }

      .file-upload h3 {
        font-size: 1.3rem;
        margin-bottom: 10px;
        color: var(--dark);
      }

      .file-upload p {
        color: var(--gray);
        margin-bottom: 15px;
      }

      .file-info {
        margin-top: 15px;
        padding: 15px;
        background-color: white;
        border-radius: var(--radius-sm);
        display: none;
        text-align: left;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--light-gray);
      }

      .cover-preview {
        width: 180px;
        height: 240px;
        background-color: var(--light-gray);
        margin: 15px auto;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--gray);
        border-radius: var(--radius-sm);
        overflow: hidden;
        position: relative;
        border: 1px solid rgba(0, 0, 0, 0.05);
      }

      .cover-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .upload-actions {
        text-align: center;
        margin-top: 40px;
        display: flex;
        justify-content: center;
        gap: 20px;
      }

      .upload-actions .btn {
        padding: 14px 30px;
        border-radius: 30px;
        min-width: 180px;
        font-weight: 500;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .upload-actions .btn-primary {
        background: linear-gradient(
          135deg,
          var(--primary),
          var(--primary-dark)
        );
        color: white;
        border: none;
      }

      .upload-actions .btn-primary:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
      }

      .upload-actions .btn-secondary {
        background-color: white;
        color: var(--dark);
        border: 1px solid var(--light-gray);
      }

      .upload-actions .btn-secondary:hover {
        background-color: var(--light);
      }

      .required {
        color: var(--danger);
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .file-info.show {
        display: block;
        animation: fadeIn 0.3s ease;
      }

      @media (max-width: 768px) {
        .upload-header h1 {
          font-size: 2rem;
        }

        .upload-form {
          padding: 25px;
        }

        .form-row {
          flex-direction: column;
          margin-bottom: 0;
        }

        .form-col {
          min-width: 100%;
          padding: 0;
        }

        .upload-actions {
          flex-direction: column;
          align-items: center;
        }

        .upload-actions .btn {
          width: 100%;
        }
      }

      @media (max-width: 576px) {
        .upload-container {
          padding: 30px 0;
        }

        .upload-header h1 {
          font-size: 1.8rem;
        }

        .file-upload {
          padding: 20px;
        }

        .file-upload-icon {
          width: 60px;
          height: 60px;
          line-height: 60px;
          font-size: 2rem;
        }

        .file-upload h3 {
          font-size: 1.1rem;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="container header-container">
        <a href="/index.html" class="logo">Ebook<span>Haven</span></a>
        <form class="search-bar">
          <input
            type="text"
            id="search-input"
            placeholder="Tìm kiếm sách, tác giả..."
          />
          <button><i class="fas fa-search"></i></button>
        </form>
        <div class="mobile-menu-toggle" id="mobile-menu-toggle">
          <span></span>
          <span></span>
          <span></span>
        </div>
        <ul class="nav-menu" id="nav-menu">
          <li>
            <a href="/index.html"><i class="fas fa-home"></i> Trang chủ</a>
          </li>
          <li>
            <a href="/categories.html"><i class="fas fa-tags"></i> Danh mục</a>
          </li>
          <li>
            <a href="/upload-book.html" class="active"
              ><i class="fas fa-upload"></i> Tải lên sách</a
            >
          </li>
          <li>
            <a href="#" id="login-btn"
              ><i class="fas fa-sign-in-alt"></i> Đăng nhập</a
            >
          </li>
          <li>
            <a href="#" id="register-btn"
              ><i class="fas fa-user-plus"></i> Đăng ký</a
            >
          </li>
        </ul>
      </div>
    </header>

    <div class="container upload-container">
      <div class="upload-header">
        <h1>Tải lên sách mới</h1>
        <p>
          Chia sẻ kiến thức và đóng góp vào thư viện cộng đồng. Vui lòng chỉ tải
          lên những sách mà bạn có quyền chia sẻ.
        </p>
      </div>

      <div class="upload-form">
        <form id="book-upload-form">
          <div class="form-row">
            <div class="form-col">
              <div class="form-group">
                <label for="title">
                  <i class="fas fa-book"></i> Tiêu đề sách
                  <span class="required">*</span>
                </label>
                <input
                  type="text"
                  id="title"
                  name="title"
                  required
                  placeholder="Nhập tiêu đề sách"
                />
              </div>

              <div class="form-group">
                <label for="author">
                  <i class="fas fa-user-edit"></i> Tác giả
                  <span class="required">*</span>
                </label>
                <input
                  type="text"
                  id="author"
                  name="author"
                  required
                  placeholder="Nhập tên tác giả"
                />
              </div>

              <div class="form-group">
                <label for="category">
                  <i class="fas fa-tags"></i> Danh mục
                  <span class="required">*</span>
                </label>
                <select id="category" name="categoryId" required>
                  <option value="">-- Chọn danh mục --</option>
                </select>
              </div>

              <div class="form-group">
                <label for="language">
                  <i class="fas fa-language"></i> Ngôn ngữ
                </label>
                <select id="language" name="language">
                  <option value="Vietnamese">Tiếng Việt</option>
                  <option value="English">Tiếng Anh</option>
                  <option value="French">Tiếng Pháp</option>
                  <option value="German">Tiếng Đức</option>
                  <option value="Spanish">Tiếng Tây Ban Nha</option>
                  <option value="Chinese">Tiếng Trung</option>
                  <option value="Japanese">Tiếng Nhật</option>
                  <option value="Korean">Tiếng Hàn</option>
                  <option value="Other">Khác</option>
                </select>
              </div>

              <div class="form-row">
                <div class="form-col">
                  <div class="form-group">
                    <label for="publishYear">
                      <i class="fas fa-calendar-alt"></i> Năm xuất bản
                    </label>
                    <input
                      type="number"
                      id="publishYear"
                      name="publishYear"
                      min="1800"
                      max="2025"
                      placeholder="Năm xuất bản"
                    />
                  </div>
                </div>
                <div class="form-col">
                  <div class="form-group">
                    <label for="pageCount">
                      <i class="fas fa-file-alt"></i> Số trang
                    </label>
                    <input
                      type="number"
                      id="pageCount"
                      name="pageCount"
                      min="1"
                      placeholder="Số trang"
                    />
                  </div>
                </div>
              </div>

              <div class="form-group">
                <label for="isbn"> <i class="fas fa-barcode"></i> ISBN </label>
                <input
                  type="text"
                  id="isbn"
                  name="isbn"
                  placeholder="Mã ISBN (nếu có)"
                />
              </div>
            </div>

            <div class="form-col">
              <div class="form-group">
                <label for="description">
                  <i class="fas fa-info-circle"></i> Mô tả sách
                </label>
                <textarea
                  id="description"
                  name="description"
                  rows="5"
                  placeholder="Mô tả ngắn gọn về nội dung sách"
                ></textarea>
              </div>

              <div class="form-group">
                <label>
                  <i class="fas fa-file-pdf"></i> File sách
                  <span class="required">*</span>
                </label>
                <div class="file-upload" id="book-file-upload">
                  <div class="file-upload-icon">
                    <i class="fas fa-file-upload"></i>
                  </div>
                  <h3>Kéo thả file hoặc click để chọn</h3>
                  <p>Hỗ trợ PDF, EPUB, MOBI (tối đa 100MB)</p>
                  <input
                    type="file"
                    id="book-file"
                    name="file"
                    accept=".pdf,.epub,.mobi"
                    required
                  />
                  <div class="file-info" id="book-file-info"></div>
                </div>
              </div>

              <div class="form-group">
                <label> <i class="fas fa-image"></i> Ảnh bìa sách </label>
                <div class="file-upload" id="cover-file-upload">
                  <div class="cover-preview" id="cover-preview">
                    <i class="fas fa-image" style="font-size: 3rem"></i>
                  </div>
                  <div class="file-upload-icon">
                    <i class="fas fa-images"></i>
                  </div>
                  <h3>Kéo thả ảnh hoặc click để chọn</h3>
                  <p>Hỗ trợ JPG, PNG (tối đa 5MB)</p>
                  <input
                    type="file"
                    id="cover-file"
                    name="cover"
                    accept="image/jpeg,image/png"
                  />
                  <div class="file-info" id="cover-file-info"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="upload-actions">
            <button type="submit" class="btn btn-primary" id="upload-button">
              <i class="fas fa-upload"></i> Tải lên
            </button>
            <button type="button" class="btn btn-secondary" id="cancel-button">
              <i class="fas fa-times"></i> Hủy
            </button>
          </div>
        </form>
      </div>
    </div>

    <footer>
      <div class="container footer-container">
        <div class="footer-col">
          <h3>Ebook Haven</h3>
          <p>
            Thư viện sách điện tử cho mọi người yêu thích đọc sách và học hỏi.
          </p>
          <div class="social-icons">
            <a href="#"><i class="fab fa-facebook-f"></i></a>
            <a href="#"><i class="fab fa-twitter"></i></a>
            <a href="#"><i class="fab fa-instagram"></i></a>
          </div>
        </div>
        <div class="footer-col">
          <h3>Khám phá</h3>
          <ul>
            <li>
              <a href="/categories.html"
                ><i class="fas fa-angle-right"></i> Danh mục</a
              >
            </li>
            <li>
              <a href="/upload-book.html"
                ><i class="fas fa-angle-right"></i> Tải lên sách</a
              >
            </li>
            <li>
              <a href="/profile.html"
                ><i class="fas fa-angle-right"></i> Trang cá nhân</a
              >
            </li>
          </ul>
        </div>
        <div class="footer-col">
          <h3>Liên kết</h3>
          <ul>
            <li>
              <a href="#"><i class="fas fa-angle-right"></i> Giới thiệu</a>
            </li>
            <li>
              <a href="#"
                ><i class="fas fa-angle-right"></i> Điều khoản sử dụng</a
              >
            </li>
            <li>
              <a href="#"
                ><i class="fas fa-angle-right"></i> Chính sách bảo mật</a
              >
            </li>
            <li>
              <a href="#"><i class="fas fa-angle-right"></i> Liên hệ</a>
            </li>
          </ul>
        </div>
        <div class="footer-col">
          <h3>Hỗ trợ</h3>
          <ul>
            <li>
              <a href="#"
                ><i class="fas fa-angle-right"></i> Câu hỏi thường gặp</a
              >
            </li>
            <li>
              <a href="#"
                ><i class="fas fa-angle-right"></i> Hướng dẫn sử dụng</a
              >
            </li>
            <li>
              <a href="#"><i class="fas fa-angle-right"></i> Báo cáo lỗi</a>
            </li>
          </ul>
        </div>
      </div>
      <div class="container">
        <div class="copyright">
          &copy; 2025 Ebook Haven. Tất cả quyền được bảo lưu.
        </div>
      </div>
    </footer>

    <script src="/assets/js/notification.js"></script>
    <script src="/assets/js/api.service.js"></script>
    <script src="/assets/js/image-utils.js"></script>
    <script src="/assets/js/helper.js"></script>
    <script src="/assets/js/main.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", async function () {
        if (!apiService.auth.isAuthenticated()) {
          showAuthModal("login");

          document.getElementById("book-upload-form").classList.add("disabled");
          document.getElementById("upload-button").disabled = true;

          notifications.warning("Bạn cần đăng nhập để tải lên sách!");
          return;
        }

        // Kiểm tra vai trò của người dùng
        const currentUser = apiService.auth.getCurrentUser();
        if (currentUser && (currentUser.role !== "admin" && currentUser.role !== "moderator")) {
          document.getElementById("book-upload-form").classList.add("disabled");
          document.getElementById("upload-button").disabled = true;

          notifications.error("Bạn cần là admin hoặc moderator để tải lên sách!");
          
          // Thêm thông báo trực quan
          const uploadContainer = document.querySelector(".upload-container");
          const warningDiv = document.createElement("div");
          warningDiv.className = "alert alert-danger";
          warningDiv.style.margin = "20px 0";
          warningDiv.style.padding = "15px";
          warningDiv.style.borderRadius = "var(--radius)";
          warningDiv.style.backgroundColor = "#ffebee";
          warningDiv.style.color = "#ef476f";
          warningDiv.style.border = "1px solid #f8bbd0";
          warningDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Chỉ admin hoặc moderator mới có quyền tải sách lên.';
          
          uploadContainer.insertBefore(warningDiv, document.querySelector(".upload-form"));
          return;
        }

        try {
          const categories = await apiService.categories.getAll();
          const categorySelect = document.getElementById("category");

          categories.forEach((category) => {
            const option = document.createElement("option");
            option.value = category.id;
            option.textContent = category.name;
            categorySelect.appendChild(option);
          });
        } catch (error) {
          console.error("Error loading categories:", error);
          notifications.error("Không thể tải danh mục sách");
        }

        const bookFileUpload = document.getElementById("book-file-upload");
        const bookFileInput = document.getElementById("book-file");
        const bookFileInfo = document.getElementById("book-file-info");

        bookFileUpload.addEventListener("dragover", function (e) {
          e.preventDefault();
          this.classList.add("dragover");
        });

        bookFileUpload.addEventListener("dragleave", function () {
          this.classList.remove("dragover");
        });

        bookFileUpload.addEventListener("drop", function (e) {
          e.preventDefault();
          this.classList.remove("dragover");

          if (e.dataTransfer.files.length) {
            bookFileInput.files = e.dataTransfer.files;
            updateFileInfo(bookFileInput, bookFileInfo);
          }
        });

        bookFileInput.addEventListener("change", function () {
          updateFileInfo(this, bookFileInfo);
        });

        const coverFileUpload = document.getElementById("cover-file-upload");
        const coverFileInput = document.getElementById("cover-file");
        const coverFileInfo = document.getElementById("cover-file-info");
        const coverPreview = document.getElementById("cover-preview");

        coverFileUpload.addEventListener("dragover", function (e) {
          e.preventDefault();
          this.classList.add("dragover");
        });

        coverFileUpload.addEventListener("dragleave", function () {
          this.classList.remove("dragover");
        });

        coverFileUpload.addEventListener("drop", function (e) {
          e.preventDefault();
          this.classList.remove("dragover");

          if (e.dataTransfer.files.length) {
            coverFileInput.files = e.dataTransfer.files;
            updateFileInfo(coverFileInput, coverFileInfo);
            previewCover(coverFileInput.files[0]);
          }
        });

        coverFileInput.addEventListener("change", function () {
          updateFileInfo(this, coverFileInfo);
          if (this.files && this.files[0]) {
            previewCover(this.files[0]);
          }
        });

        function previewCover(file) {
          if (!file.type.match("image.*")) {
            notifications.error("Vui lòng chọn file ảnh hợp lệ!");
            return;
          }

          const reader = new FileReader();

          reader.onload = function (e) {
            coverPreview.innerHTML = `<img src="${e.target.result}" alt="Cover Preview">`;
          };

          reader.readAsDataURL(file);
        }

        function updateFileInfo(input, infoElement) {
          if (input.files && input.files[0]) {
            const file = input.files[0];
            const fileSize = formatFileSize(file.size);
            const fileType = getFileTypeName(file.type);

            infoElement.innerHTML = `
              <strong>Tên file:</strong> ${file.name}<br>
              <strong>Kích thước:</strong> ${fileSize}<br>
              <strong>Loại:</strong> ${fileType}
            `;
            infoElement.classList.add("show");
          }
        }

        function getFileTypeName(mimeType) {
          const types = {
            "application/pdf": "PDF Document",
            "application/epub+zip": "EPUB eBook",
            "application/x-mobipocket-ebook": "MOBI eBook",
            "image/jpeg": "JPEG Image",
            "image/png": "PNG Image",
          };

          return types[mimeType] || mimeType;
        }

        function formatFileSize(bytes) {
          if (bytes >= 1024 * 1024) {
            return (bytes / (1024 * 1024)).toFixed(2) + " MB";
          } else if (bytes >= 1024) {
            return (bytes / 1024).toFixed(2) + " KB";
          } else {
            return bytes + " bytes";
          }
        }

        document
          .getElementById("cancel-button")
          .addEventListener("click", function () {
            if (confirm("Bạn có chắc muốn hủy việc tải lên sách?")) {
              window.location.href = "/index.html";
            }
          });

        document
          .getElementById("book-upload-form")
          .addEventListener("submit", async function (e) {
            e.preventDefault();

            if (!apiService.auth.isAuthenticated()) {
              showAuthModal("login");
              return;
            }

            // Kiểm tra các trường bắt buộc
            const title = document.getElementById("title").value.trim();
            const author = document.getElementById("author").value.trim();
            const category = document.getElementById("category").value;
            const bookFile = document.getElementById("book-file").files[0];

            if (!title || !author || !category || !bookFile) {
              notifications.error(
                "Vui lòng điền đầy đủ thông tin bắt buộc (tiêu đề, tác giả, danh mục và file sách)!"
              );
              return;
            }

            const formData = new FormData();

            formData.append("title", title);
            formData.append("author", author);
            formData.append("categoryId", category);
            formData.append(
              "description",
              document.getElementById("description").value
            );
            formData.append(
              "language",
              document.getElementById("language").value
            );

            const publishYear = document.getElementById("publishYear").value;
            if (publishYear) {
              formData.append("publishYear", publishYear);
            }

            const pageCount = document.getElementById("pageCount").value;
            if (pageCount) {
              formData.append("pageCount", pageCount);
            }

            const isbn = document.getElementById("isbn").value;
            if (isbn) {
              formData.append("isbn", isbn);
            }

            formData.append("file", bookFile);

            const coverFile = document.getElementById("cover-file").files[0];
            if (coverFile) {
              formData.append("cover", coverFile);
            }

            const uploadButton = document.getElementById("upload-button");
            const originalBtnText = uploadButton.innerHTML;
            uploadButton.innerHTML =
              '<i class="fas fa-spinner fa-spin"></i> Đang tải lên...';
            uploadButton.disabled = true;

            try {
              const response = await apiService.books.create({
                title,
                author,
                categoryId: category,
                description: document.getElementById("description").value,
                language: document.getElementById("language").value,
                publishYear: publishYear || null,
                pageCount: pageCount || null,
                isbn: isbn || null,
                file: bookFile,
                cover: coverFile || null,
              });

              if (response.id) {
                notifications.success("Tải sách lên thành công!");
                setTimeout(() => {
                  window.location.href = `book-detail.html?id=${response.id}`;
                }, 1000);
              } else {
                notifications.error(
                  response.message || "Lỗi khi tải sách lên!"
                );
                uploadButton.innerHTML = originalBtnText;
                uploadButton.disabled = false;
              }
            } catch (error) {
              console.error("Error uploading book:", error);
              notifications.error(
                "Lỗi khi tải sách lên: " +
                  (error.message || "Không kết nối được với server")
              );
              uploadButton.innerHTML = originalBtnText;
              uploadButton.disabled = false;
            }
          });
      });
    </script>
    <div id="notification-container"></div>
  </body>
</html>
